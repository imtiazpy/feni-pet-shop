{% extends template_to_extend %} 
{% load static %} 



{% block content %}
<div class="mb-6 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Product List</h1>

  <div class="flex items-center gap-3">
    <button class="btn btn-primary btn-sm">
      Export {% include 'includes/svg/export_icon.html' %}
    </button>

    {% if request.user.role == 'admin' or request.user.role == 'inventory_manager' %}
    <a 
      class="btn btn-primary btn-sm" 
      title="Create Product"
      hx-get="{% url 'products:product_create' %}" 
      hx-target="#productModalContent"
      hx-swap="innerHTML"
      onclick="productModal.showModal()"
    >
      Add Product
      <span class="w-4 h-4 flex items-center justify-center">
        {% include 'includes/svg/plus_icon.html' %}
      </span>
    </a>
    {% endif %}
  </div>
</div>

<!-- Filters & Search -->
<div class="mb-6 bg-base-100 rounded-lg shadow-sm border border-base-300 p-4">
  <form method="get" class="flex flex-wrap gap-4 items-end">
    <div class="form-control">
      <label class="label">
        <span class="label-text font-medium">Filter by Category</span>
      </label>
      <select name="category_id" class="select select-bordered select-sm w-48 bg-white dark:bg-gray-700">
        <option value="">All Products</option>
        {% for category in categories %}
        <option value="{{ category.id }}" {% if request.GET.category_id == category.id|stringformat:"s" %}selected{% endif %}>
          {{ category.name }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-control w-64">
      <label class="label" for="search">
        <span class="label-text font-medium">Search Products</span>
      </label>
      <input 
        type="text" 
        id="search" 
        name="search" 
        value="{{ request.GET.search }}" 
        placeholder="Type product name or barcode..." 
        class="input input-bordered input-sm w-full bg-white dark:bg-gray-700"
        autocomplete="off"
        hx-get="{% url 'products:product_list_partial' %}"
        hx-trigger="keyup changed delay:500ms"
        hx-target="#product-list-container"
        hx-include="[name='search']"
      />
    </div>

    <div class="form-control">
      <button type="submit" class="btn btn-neutral btn-sm">
        <span class="w-4 h-4 flex items-center justify-center">
          {% include 'includes/svg/search_icon.html' %}
        </span>
        Filter
      </button>
    </div>

    {% if request.GET.category_id or request.GET.search %}
    <div class="form-control">
      <a href="{% url 'products:product_list' %}" class="btn btn-ghost btn-sm">
        Clear Filters
      </a>
    </div>
    {% endif %}
  </form>
</div>
  
<div id="product-list-container" class="overflow-x-auto bg-base-100 rounded-lg shadow-lg border border-base-300">
  {% include "products/partials/product_list_partial.html" %}
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="mt-6 flex justify-center">
  <div class="join bg-base-100 shadow-sm rounded-lg border border-base-300">
    {% if page_obj.has_previous %}
      <a 
        href="?page=1{% if request.GET.category_id %}&category_id={{ request.GET.category_id }}{% endif %}" class="join-item btn btn-sm btn-ghost hover:bg-base-200"
      >
        First
      </a>
      <a 
        href="?page={{ page_obj.previous_page_number }}{% if request.GET.category_id %}&category_id={{ request.GET.category_id }}{% endif %}" 
        class="join-item btn btn-sm btn-ghost hover:bg-base-200"
      >
        ‹ Prev
      </a>
    {% endif %}
    <span class="join-item btn btn-sm btn-active">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>
    {% if page_obj.has_next %}
      <a 
        href="?page={{ page_obj.next_page_number }}{% if request.GET.category_id %}&category_id={{ request.GET.category_id }}{% endif %}" 
        class="join-item btn btn-sm btn-ghost hover:bg-base-200"
      >
        Next ›
      </a>
      <a 
        href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.category_id %}&category_id={{ request.GET.category_id }}{% endif %}" 
        class="join-item btn btn-sm btn-ghost hover:bg-base-200"
      >
        Last
      </a>
    {% endif %}
  </div>
</div>
{% endif %}

{% comment %} Product create/update/detail/price-update Modal {% endcomment %}

<dialog id="productModal" class="modal">
  <div class="modal-box max-w-4xl bg-white dark:bg-gray-700 border border-base-300">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3 hover:bg-base-200">✕</button>
    </form>
    <div id="productModalContent" class="mt-4">
      <div class="flex items-center justify-center py-8">
        <span class="loading loading-spinner loading-md text-primary"></span>
      </div>
    </div>
  </div>
</dialog>

{% endblock %}

{% block extra_script %}
<script>
  function bindProductDeleteLogic() {
    const input = document.getElementById('confirmText');
    const button = document.getElementById('deleteButton');
  
    if (!input || !button) {
      return;
    }
  
    input.addEventListener('input', function () {
      const value = input.value.trim();
  
      if (value === 'DELETE') {
        button.removeAttribute('disabled');
      } else {
        button.setAttribute('disabled', 'true');
      }
    });
  }

  document.body.addEventListener('htmx:afterSwap', (event) => {
    const modalContent = event.target;

    if (modalContent.id === 'productModalContent' && modalContent.querySelector('[data-delete-modal]')) {
      console.log('HTMX swap completed. Binding delete logic.');
      bindProductDeleteLogic();
    }
  });
</script>
  
{% endblock %}
