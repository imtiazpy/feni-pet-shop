{% extends template_to_extend %}
{% load static %}
{% block title %}Profile | Pet IMS{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-white">User Profile</h1>
  <div class="flex gap-2">
    <button @click="editMode = !editMode" class="btn btn-primary btn-sm" x-data="{editMode: false}">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l-6 6v3h3l6-6m2-2l6-6a2.121 2.121 0 00-3-3l-6 6M9 11l6 6"/>
      </svg>
      Edit Profile
    </button>
  </div>
</div>

<div x-data="profileManager()" class="max-w-5xl mx-auto space-y-6">
  <!-- Profile Header Card -->
  <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 overflow-hidden">
    <!-- Cover Image Section -->
    <div class="h-32 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 relative">
      <div class="absolute inset-0 bg-black bg-opacity-20"></div>
      <button @click="openCoverModal()" class="absolute top-4 right-4 btn btn-sm btn-circle btn-ghost bg-black bg-opacity-50 text-white hover:bg-black hover:bg-opacity-70">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
        </svg>
      </button>
    </div>

    <!-- Profile Info Section -->
    <div class="p-6 -mt-16 relative">
      <div class="flex flex-col sm:flex-row gap-6 items-start sm:items-end">
        <!-- Avatar -->
        <div class="relative">
          <div class="avatar">
            <div class="w-32 h-32 rounded-full ring ring-4 ring-base-100 ring-offset-4 ring-offset-transparent">
              <img :src="userProfile.avatar || 'https://i.pravatar.cc/150?img=' + userProfile.id" 
                   :alt="userProfile.full_name" class="object-cover" />
            </div>
          </div>
          <button @click="openAvatarModal()" 
                  class="absolute bottom-2 right-2 btn btn-sm btn-circle btn-primary">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l-6 6v3h3l6-6m2-2l6-6a2.121 2.121 0 00-3-3l-6 6M9 11l6 6"/>
            </svg>
          </button>
        </div>

        <!-- User Details -->
        <div class="flex-1 space-y-2">
          <div>
            <h2 class="text-2xl font-bold text-base-content" x-text="userProfile.full_name"></h2>
            <p class="text-base-content/70" x-text="userProfile.email"></p>
          </div>
          <div class="flex flex-wrap gap-2">
            <span class="badge badge-primary badge-lg" x-text="userProfile.role"></span>
            <span class="badge badge-outline" x-text="'Employee ID: ' + userProfile.employee_id"></span>
            <span class="badge badge-success" x-show="userProfile.is_active">Active</span>
            <span class="badge badge-error" x-show="!userProfile.is_active">Inactive</span>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 gap-4 text-center">
          <div class="bg-base-200/50 rounded-lg p-3">
            <div class="text-2xl font-bold text-primary" x-text="userProfile.stats.sales_count || 0"></div>
            <div class="text-xs text-base-content/60">Sales</div>
          </div>
          <div class="bg-base-200/50 rounded-lg p-3">
            <div class="text-2xl font-bold text-success" x-text="userProfile.stats.days_active || 0"></div>
            <div class="text-xs text-base-content/60">Days Active</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Personal Information -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Contact Information -->
      <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6">
        <h3 class="text-xl font-semibold text-base-content mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          Contact Information
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Phone Number -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Phone Number</span>
            </label>
            <div class="flex items-center gap-2">
              <input type="tel" :value="userProfile.phone" readonly
                     class="input input-bordered flex-1 bg-base-200/50">
              <button disabled @click="openPhoneModal()" class="btn btn-ghost btn-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l-6 6v3h3l6-6m2-2l6-6a2.121 2.121 0 00-3-3l-6 6M9 11l6 6"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Address -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Address</span>
            </label>
            <div class="flex items-center gap-2">
              <input type="text" :value="userProfile.address || 'Not provided'" readonly
                     class="input input-bordered flex-1 bg-base-200/50">
              <button disabled @click="openAddressModal()" class="btn btn-ghost btn-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l-6 6v3h3l6-6m2-2l6-6a2.121 2.121 0 00-3-3l-6 6M9 11l6 6"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Department -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Department</span>
            </label>
            <input type="text" :value="userProfile.department || 'General'" readonly
                   class="input input-bordered bg-base-200/50">
          </div>

          <!-- Date of Birth -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Date of Birth</span>
            </label>
            <div class="flex items-center gap-2">
              <input type="date" :value="userProfile.date_of_birth" readonly
                     class="input input-bordered flex-1 bg-base-200/50">
              <button disabled @click="openDobModal()" class="btn btn-ghost btn-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l-6 6v3h3l6-6m2-2l6-6a2.121 2.121 0 00-3-3l-6 6M9 11l6 6"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Settings -->
      <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6">
        <h3 class="text-xl font-semibold text-base-content mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
          Security Settings
        </h3>
        
        <div class="space-y-4">
          <div class="flex justify-between items-center p-4 bg-base-200/30 rounded-lg">
            <div>
              <h4 class="font-medium">Password</h4>
              <p class="text-sm text-base-content/60">Last changed 30 days ago</p>
            </div>
            <button disabled @click="openPasswordModal()" class="btn btn-outline btn-sm">
              Change Password
            </button>
          </div>

          <div class="flex justify-between items-center p-4 bg-base-200/30 rounded-lg">
            <div>
              <h4 class="font-medium">Two-Factor Authentication</h4>
              <p class="text-sm text-base-content/60">Add an extra layer of security</p>
            </div>
            <input type="checkbox" class="toggle toggle-primary" :checked="userProfile.two_factor_enabled">
          </div>
        </div>
      </div>
    </div>

    <!-- Activity & Stats Sidebar -->
    <div class="space-y-6">
      <!-- Account Activity -->
      <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6">
        <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Activity
        </h3>
        
        <div class="space-y-3 text-sm">
          <div class="flex justify-between">
            <span class="text-base-content/60">Last Login</span>
            <span class="font-medium" x-text="formatDate(userProfile.last_login)"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-base-content/60">Joined On</span>
            <span class="font-medium" x-text="formatDate(userProfile.date_joined)"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-base-content/60">Profile Updated</span>
            <span class="font-medium" x-text="formatDate(userProfile.updated_at)"></span>
          </div>
        </div>
      </div>

      <!-- Performance Stats -->
      <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6">
        <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          This Month
        </h3>
        
        <div class="space-y-4">
          <div class="text-center">
            <div class="text-3xl font-bold text-primary" x-text="userProfile.stats.monthly_sales || 0"></div>
            <div class="text-xs text-base-content/60">Sales Completed</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-success" x-text="'৳ ' + (userProfile.stats.monthly_revenue || 0).toFixed(2)"></div>
            <div class="text-xs text-base-content/60">Revenue Generated</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-info" x-text="userProfile.stats.monthly_customers || 0"></div>
            <div class="text-xs text-base-content/60">Customers Served</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6">
        <h3 class="text-lg font-semibold text-base-content mb-4">Quick Actions</h3>
        <div class="space-y-2">
          <button class="btn btn-outline btn-sm w-full justify-start">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Download Profile Data
          </button>
          <button @click="openPreferencesModal()" class="btn btn-outline btn-sm w-full justify-start">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Preferences
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Avatar Upload Modal -->
<dialog x-ref="avatarModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Update Profile Picture</h3>
    <form @submit.prevent="updateAvatar()" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text">Choose new avatar</span>
        </label>
        <input type="file" accept="image/*" @change="handleAvatarFile($event)" 
               class="file-input file-input-bordered w-full" />
      </div>
      <div x-show="avatarPreview" class="flex justify-center">
        <img :src="avatarPreview" alt="Preview" class="w-24 h-24 rounded-full object-cover">
      </div>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary" :disabled="!selectedAvatarFile">
          Update Avatar
        </button>
        <button type="button" @click="closeAvatarModal()" class="btn btn-ghost">
          Cancel
        </button>
      </div>
    </form>
  </div>
</dialog>

<!-- Phone Update Modal -->
<dialog x-ref="phoneModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Update Phone Number</h3>
    <form @submit.prevent="updatePhone()" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text">Phone Number</span>
        </label>
        <input type="tel" x-model="editPhone" 
               class="input input-bordered w-full" 
               placeholder="Enter phone number" required>
      </div>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary">
          Update Phone
        </button>
        <button type="button" @click="closePhoneModal()" class="btn btn-ghost">
          Cancel
        </button>
      </div>
    </form>
  </div>
</dialog>

<!-- Address Update Modal -->
<dialog x-ref="addressModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Update Address</h3>
    <form @submit.prevent="updateAddress()" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text">Address</span>
        </label>
        <textarea x-model="editAddress" 
                  class="textarea textarea-bordered w-full" 
                  placeholder="Enter your address" rows="3"></textarea>
      </div>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary">
          Update Address
        </button>
        <button type="button" @click="closeAddressModal()" class="btn btn-ghost">
          Cancel
        </button>
      </div>
    </form>
  </div>
</dialog>

<!-- Password Change Modal -->
<dialog x-ref="passwordModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Change Password</h3>
    <form @submit.prevent="changePassword()" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text">Current Password</span>
        </label>
        <input type="password" x-model="passwordForm.current" 
               class="input input-bordered w-full" required>
      </div>
      <div class="form-control">
        <label class="label">
          <span class="label-text">New Password</span>
        </label>
        <input type="password" x-model="passwordForm.new" 
               class="input input-bordered w-full" required>
      </div>
      <div class="form-control">
        <label class="label">
          <span class="label-text">Confirm New Password</span>
        </label>
        <input type="password" x-model="passwordForm.confirm" 
               class="input input-bordered w-full" required>
      </div>
      <div class="modal-action">
        <button type="submit" class="btn btn-primary">
          Change Password
        </button>
        <button type="button" @click="closePasswordModal()" class="btn btn-ghost">
          Cancel
        </button>
      </div>
    </form>
  </div>
</dialog>

{% endblock %}

{% block extra_script %}
<script>
function profileManager() {
  return {
    userProfile: {
      id: 1,
      full_name: 'John Doe',
      email: 'johndoe@petims.com',
      phone: '+8801234567890',
      address: '123 Main Street, Dhaka, Bangladesh',
      department: 'Sales',
      role: 'Inventory Manager',
      employee_id: 'EMP001',
      is_active: true,
      two_factor_enabled: false,
      date_of_birth: '1990-01-15',
      last_login: '2024-08-08T10:30:00',
      date_joined: '2023-11-12T00:00:00',
      updated_at: '2024-08-01T15:20:00',
      avatar: null,
      stats: {
        sales_count: 145,
        days_active: 270,
        monthly_sales: 23,
        monthly_revenue: 125000,
        monthly_customers: 89
      }
    },
    
    // Edit forms
    editPhone: '',
    editAddress: '',
    selectedAvatarFile: null,
    avatarPreview: null,
    
    passwordForm: {
      current: '',
      new: '',
      confirm: ''
    },

    init() {
      // Initialize edit forms with current values
      this.editPhone = this.userProfile.phone;
      this.editAddress = this.userProfile.address;
    },

    formatDate(dateString) {
      if (!dateString) return 'Not available';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    },

    // Modal handlers
    openAvatarModal() {
      this.$refs.avatarModal.showModal();
    },

    closeAvatarModal() {
      this.$refs.avatarModal.close();
      this.selectedAvatarFile = null;
      this.avatarPreview = null;
    },

    openPhoneModal() {
      this.editPhone = this.userProfile.phone;
      this.$refs.phoneModal.showModal();
    },

    closePhoneModal() {
      this.$refs.phoneModal.close();
    },

    openAddressModal() {
      this.editAddress = this.userProfile.address;
      this.$refs.addressModal.showModal();
    },

    closeAddressModal() {
      this.$refs.addressModal.close();
    },

    openPasswordModal() {
      this.passwordForm = { current: '', new: '', confirm: '' };
      this.$refs.passwordModal.showModal();
    },

    closePasswordModal() {
      this.$refs.passwordModal.close();
    },

    // File handling
    handleAvatarFile(event) {
      const file = event.target.files[0];
      if (file) {
        this.selectedAvatarFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          this.avatarPreview = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    },

    // Update methods
    async updateAvatar() {
      if (!this.selectedAvatarFile) return;

      // Simulate API call
      console.log('Updating avatar...', this.selectedAvatarFile);
      
      // Update local state
      this.userProfile.avatar = this.avatarPreview;
      
      alert('Avatar updated successfully!');
      this.closeAvatarModal();
    },

    async updatePhone() {
      if (!this.editPhone.trim()) return;

      // Simulate API call
      console.log('Updating phone...', this.editPhone);
      
      // Update local state
      this.userProfile.phone = this.editPhone;
      
      alert('Phone number updated successfully!');
      this.closePhoneModal();
    },

    async updateAddress() {
      // Simulate API call
      console.log('Updating address...', this.editAddress);
      
      // Update local state
      this.userProfile.address = this.editAddress || 'Not provided';
      
      alert('Address updated successfully!');
      this.closeAddressModal();
    },

    async changePassword() {
      if (this.passwordForm.new !== this.passwordForm.confirm) {
        alert('New passwords do not match!');
        return;
      }

      if (this.passwordForm.new.length < 8) {
        alert('Password must be at least 8 characters long!');
        return;
      }

      // Simulate API call
      console.log('Changing password...');
      
      alert('Password changed successfully!');
      this.closePasswordModal();
    }
  }
}
</script>

<style>
[x-cloak] { 
  display: none !important; 
}

/* Custom scrollbar for stats */
.stats-container {
  scrollbar-width: thin;
  scrollbar-color: theme(colors.base-300) transparent;
}

.stats-container::-webkit-scrollbar {
  width: 6px;
}

.stats-container::-webkit-scrollbar-track {
  background: transparent;
}

.stats-container::-webkit-scrollbar-thumb {
  background-color: theme(colors.base-300);
  border-radius: 3px;
}
</style>
{% endblock %}