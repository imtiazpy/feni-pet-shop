{% extends template_to_extend %}
{% load static %}
{% block title %}Create Sale | Pet IMS{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Create New Sale</h1>
  <a href="{% url 'sales:sale_list' %}" class="btn btn-ghost btn-sm">
    <span class="w-4 h-4 flex items-center justify-center">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 15.75L3 12m0 0l3.75-3.75M3 12h18" />
      </svg>
    </span>
    Back to Sales
  </a>
</div>

<div x-data="saleManager()" x-init="init()">
  <form id="saleForm" method="post" class="space-y-6" @submit.prevent="validateAndSubmit">
    {% csrf_token %}
    
    <!-- Sale Items Section -->
    <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-base-content flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          Sale Items
        </h2>
        <button type="button" @click="openItemModal()" class="btn btn-primary btn-sm">
          <span class="w-4 h-4 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          </span>
          Add Item
        </button>
      </div>

      <!-- Empty state -->
      <div x-show="selectedItems.length === 0" class="text-center py-8 text-base-content/60">
        <div class="flex flex-col items-center gap-2">
          <div class="w-12 h-12 rounded-full bg-base-200 flex items-center justify-center">
            <span class="text-base-content/40 text-xl">üõí</span>
          </div>
          <span class="font-medium">No items added yet</span>
          <span class="text-sm text-base-content/40">Click "Add Item" to start building the sale</span>
        </div>
      </div>

      <!-- Items Summary Table -->
      <div x-show="selectedItems.length > 0" class="mt-6">
        <div class="overflow-x-auto bg-base-100 rounded-lg border border-base-300">
          <table class="table w-full text-sm">
            <thead class="bg-base-200/50">
              <tr>
                <th class="font-semibold">Product</th>
                <th class="font-semibold">Batch</th>
                <th class="font-semibold">Qty</th>
                <th class="font-semibold">Unit Price</th>
                <th class="font-semibold">Line Total</th>
                <th class="font-semibold">Action</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(item, index) in selectedItems" :key="item.stockId">
                <tr>
                  <td>
                    <div class="flex items-center gap-2">
                      <img x-show="item.productImage" :src="item.productImage" alt="Product" class="w-8 h-8 rounded object-cover">
                      <span class="font-medium" x-text="item.productName"></span>
                    </div>
                  </td>
                  <td class="font-mono text-xs" x-text="item.batch || '‚Äî'"></td>
                  <td>
                    <input type="number" x-model.number="item.quantity" :min="1" :max="item.available"
                           class="input input-xs input-bordered w-20" @input="updatePaymentSummary()">
                    <div class="text-xs text-gray-500 mt-1" x-text="'Max: ' + item.available"></div>
                  </td>
                  <td class="font-semibold text-info" x-text="'‡ß≥ ' + item.salePrice.toFixed(2)"></td>
                  <td class="font-bold text-success" x-text="'‡ß≥ ' + (item.quantity * item.salePrice).toFixed(2)"></td>
                  <td>
                    <button type="button" @click="removeItem(index)" class="btn btn-error btn-xs">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Hidden inputs for form submission -->
        <template x-for="(item, index) in selectedItems" :key="item.stockId">
          <div>
            <input type="hidden" :name="'stock_item_' + index" :value="item.stockId">
            <input type="hidden" :name="'quantity_' + index" x-model="item.quantity">
            <input type="hidden" :name="'sale_price_' + index" :value="item.salePrice">
          </div>
        </template>
      </div>
    </div>

    <!-- Payment Details -->
    <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6">
      <h2 class="text-xl font-semibold text-base-content mb-4 flex items-center">
        <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
        </svg>
        Payment Details
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Discount Amount (‡ß≥)</span>
            </label>
            <input type="number" name="discount_amount" x-model.number="discountAmount" step="0.01" min="0" value="0.00"
                   class="input input-bordered bg-white dark:bg-gray-700" placeholder="0.00" @input="updatePaymentSummary()">
          </div>

          <!-- Amount Received Field -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Amount Received (‡ß≥)</span>
              <span class="label-text-alt text-red-500">*</span>
            </label>
            <input type="number" name="amount_received" x-model.number="amountReceived" step="0.01" min="0"
                   class="input input-bordered bg-white dark:bg-gray-700" 
                   :class="{'input-error border-red-500': amountReceived > 0 && amountReceived < finalTotal}"
                   placeholder="0.00" @input="updatePaymentSummary()" required>
            <label class="label" x-show="amountReceived > 0 && amountReceived < finalTotal">
              <span class="label-text-alt text-red-500">‚ö†Ô∏è Insufficient amount received</span>
            </label>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Notes (Optional)</span>
            </label>
            <textarea name="notes" x-model="notes" class="textarea textarea-bordered bg-white dark:bg-gray-700" 
                      placeholder="Add any additional notes for this sale..." rows="3"></textarea>
          </div>
        </div>

        <div class="space-y-4">
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
            <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-3">Payment Summary</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-700 dark:text-gray-300">Subtotal:</span>
                <span class="font-semibold text-blue-600 dark:text-blue-400" x-text="'‡ß≥ ' + subtotal.toFixed(2)"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-700 dark:text-gray-300">Discount:</span>
                <span class="font-semibold text-orange-600 dark:text-orange-400" x-text="'‡ß≥ ' + discountAmount.toFixed(2)"></span>
              </div>
              <hr class="border-gray-300 dark:border-gray-600">
              <div class="flex justify-between text-lg">
                <span class="font-bold text-gray-900 dark:text-gray-100">Total Amount:</span>
                <span class="font-bold text-green-600 dark:text-green-400" x-text="'‡ß≥ ' + finalTotal.toFixed(2)"></span>
              </div>
              
              <!-- Amount Received Display -->
              <div x-show="amountReceived > 0" class="pt-2 border-t border-gray-300 dark:border-gray-600">
                <div class="flex justify-between">
                  <span class="text-gray-700 dark:text-gray-300">Amount Received:</span>
                  <span class="font-semibold text-blue-600 dark:text-blue-400" x-text="'‡ß≥ ' + amountReceived.toFixed(2)"></span>
                </div>
                
                <!-- Change Amount -->
                <div x-show="changeAmount !== 0" class="flex justify-between text-lg font-bold mt-2 p-2 rounded"
                     :class="changeAmount >= 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'">
                  <span x-text="changeAmount >= 0 ? 'Change Due:' : 'Amount Due:'"></span>
                  <span x-text="'‡ß≥ ' + Math.abs(changeAmount).toFixed(2)"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Amount Buttons -->
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800">
            <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-3 text-sm">Quick Amount Entry</h4>
            <div class="grid grid-cols-3 gap-2">
              <template x-for="amount in quickAmounts" :key="amount">
                <button type="button" @click="setQuickAmount(amount)" 
                        class="btn btn-sm btn-outline btn-primary text-xs"
                        x-text="'‡ß≥ ' + amount"></button>
              </template>
              <button type="button" @click="setExactAmount()" 
                      class="btn btn-sm btn-outline btn-secondary text-xs col-span-3">Exact Amount</button>
            </div>
          </div>

          <div class="alert alert-info text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>Stock will be automatically deducted upon sale completion.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3 pt-4">
      <button type="submit" :disabled="!canCompleteSale" 
              class="btn flex-1"
              :class="canCompleteSale ? 'btn-success' : 'btn-disabled'">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span x-text="getCompleteButtonText()"></span>
      </button>
      <a href="{% url 'sales:sale_list' %}" class="btn btn-ghost flex-1">
        Cancel
      </a>
    </div>

    <!-- Hidden field for item count -->
    <input type="hidden" name="item_count" x-model="selectedItems.length">
  </form>

  <!-- Item Selection Modal -->
  <div x-show="showModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <!-- Background overlay -->
      <div x-show="showModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" 
           x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" 
           x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
           class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="closeItemModal()"></div>

      <!-- Modal panel -->
      <div x-show="showModal" x-transition:enter="ease-out duration-300" 
           x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
           x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
           x-transition:leave="ease-in duration-200" 
           x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
           x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
           class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
        
        <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Select Product to Add</h3>
            <button @click="closeItemModal()" class="btn btn-sm btn-circle btn-ghost">‚úï</button>
          </div>
          
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text font-medium">Search Product</span>
            </label>
            <input 
              type="text" 
              name="search" 
              placeholder="Type product name or batch number..." 
              class="input input-bordered w-full bg-white dark:bg-gray-700"
              autocomplete="off"
              hx-get="{% url 'stock:stockitem_search' %}"
              hx-trigger="keyup changed delay:500ms"
              hx-target="#stock-items-container"
              hx-include="[name='search']"
            >
          </div>

          <div id="stock-items-container" class="overflow-x-auto max-h-96">
            <!-- HTMX will inject search results here -->
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-2">üîç</div>
              <p>Start typing to search for products...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_script %}
<script>
function saleManager() {
  return {
    selectedItems: [],
    showModal: false,
    discountAmount: 0,
    amountReceived: 0,
    notes: '',
    
    init() {
      // Expose selectProduct to global scope for HTMX callbacks
      window.selectProduct = this.selectProduct.bind(this);
    },

    get subtotal() {
      return this.selectedItems.reduce((sum, item) => sum + (item.quantity * item.salePrice), 0);
    },

    get finalTotal() {
      return Math.max(0, this.subtotal - this.discountAmount);
    },

    get changeAmount() {
      return this.amountReceived - this.finalTotal;
    },

    get canCompleteSale() {
      return this.selectedItems.length > 0 && 
             this.amountReceived > 0 && 
             this.amountReceived >= this.finalTotal;
    },

    get quickAmounts() {
      const total = this.finalTotal;
      if (total <= 0) return [100, 500, 1000];
      
      // Generate smart quick amounts based on total
      const amounts = [];
      const roundedTotal = Math.ceil(total);
      
      // Add exact amount
      amounts.push(roundedTotal);
      
      // Add common denominations above total
      const denominations = [10, 20, 50, 100, 200, 500, 1000, 2000, 5000];
      
      denominations.forEach(denom => {
        if (denom > total && amounts.length < 6) {
          amounts.push(denom);
        }
      });
      
      // Ensure we have at least a few options
      if (amounts.length < 3) {
        amounts.push(roundedTotal + 50, roundedTotal + 100, roundedTotal + 500);
      }
      
      return [...new Set(amounts)].sort((a, b) => a - b).slice(0, 6);
    },

    openItemModal() {
      this.showModal = true;
    },

    closeItemModal() {
      this.showModal = false;
      // Clear search input and results when closing
      const searchInput = document.querySelector('input[name="search"]');
      if (searchInput) searchInput.value = '';
      
      document.getElementById('stock-items-container').innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <div class="text-4xl mb-2">üîç</div>
          <p>Start typing to search for products...</p>
        </div>
      `;
    },

    selectProduct(stockItem) {
      // Check if item already exists
      const existingItem = this.selectedItems.find(item => item.stockId === stockItem.id);
      if (existingItem) {
        alert('This product is already added to the sale.');
        return;
      }

      // Add item to selected items
      this.selectedItems.push({
        stockId: stockItem.id,
        productName: stockItem.productName,
        productImage: stockItem.productImage || '',
        batch: stockItem.batch || '',
        available: stockItem.available,
        salePrice: stockItem.salePrice,
        quantity: 1
      });

      this.updatePaymentSummary();
      this.closeItemModal();
    },

    removeItem(index) {
      this.selectedItems.splice(index, 1);
      this.updatePaymentSummary();
    },

    setQuickAmount(amount) {
      this.amountReceived = amount;
      this.updatePaymentSummary();
    },

    setExactAmount() {
      this.amountReceived = this.finalTotal;
      this.updatePaymentSummary();
    },

    getCompleteButtonText() {
      if (this.selectedItems.length === 0) {
        return 'Add Items to Continue';
      }
      if (this.amountReceived === 0) {
        return 'Enter Amount Received';
      }
      if (this.amountReceived < this.finalTotal) {
        return `Need ‡ß≥${(this.finalTotal - this.amountReceived).toFixed(2)} More`;
      }
      if (this.changeAmount > 0) {
        return `Complete Sale (Change: ‡ß≥${this.changeAmount.toFixed(2)})`;
      }
      return 'Complete Sale';
    },

    updatePaymentSummary() {
      // Payment summary is automatically updated by computed properties
    },

    validateAndSubmit(event) {
      if (this.selectedItems.length === 0) {
        alert('Please add at least one item to the sale.');
        return;
      }

      if (this.amountReceived === 0) {
        alert('Please enter the amount received from customer.');
        document.querySelector('input[name="amount_received"]').focus();
        return;
      }

      if (this.amountReceived < this.finalTotal) {
        alert(`Insufficient amount received. Need ‡ß≥${(this.finalTotal - this.amountReceived).toFixed(2)} more.`);
        document.querySelector('input[name="amount_received"]').focus();
        return;
      }

      if (this.discountAmount > this.subtotal) {
        alert('Discount amount cannot exceed the subtotal.');
        return;
      }

      // Validate quantities
      for (let item of this.selectedItems) {
        if (item.quantity > item.available) {
          alert(`Quantity for ${item.productName} exceeds available stock.`);
          return;
        }
      }

      // Show change confirmation if there's change due
      if (this.changeAmount > 0) {
        const confirmed = confirm(`Change due: ‡ß≥${this.changeAmount.toFixed(2)}\n\nDo you want to complete this sale?`);
        if (!confirmed) return;
      }

      // Submit the form
      event.target.submit();
    }
  }
}
</script>
{% endblock %}

<style>
[x-cloak] { 
  display: none !important; 
}
</style>

{% endblock %}