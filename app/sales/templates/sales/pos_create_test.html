{% extends template_to_extend %}
{% load static %}
{% block title %}PoS Sale | Pet IMS{% endblock %}


{% block extra_css %}
<style>
  [x-cloak] {
    display: none !important;
  }

  /* Focus styles for barcode input */
  .focus\:ring-4:focus {
    ring-width: 4px;
  }

  /* Scanner ready pulse animation */
  .scanner-ready {
    animation: pulse 2s infinite;
  }

  @keyframes pulse {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.7;
    }
  }

  /* Smooth transitions for alerts */
  [x-transition] {
    transition: all 0.3s ease-in-out;
  }

  /* Keyboard shortcut styling */
  kbd {
    @apply bg-gray-200 dark:bg-gray-700 px-1 py-0.5 rounded text-xs font-mono;
  }

  /* Enhanced button states */
  .btn:disabled {
    @apply opacity-50 cursor-not-allowed;
  }

  /* Cart item hover effects */
  .hover\:bg-base-200\/30:hover {
    background-color: rgba(var(--b2), 0.3);
  }

  /* Quick amount button grid responsive */
  @media (max-width: 640px) {
    .grid-cols-3 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  /* Custom input validation states */
  .input-error {
    @apply border-red-500 focus:border-red-500 focus:ring-red-200;
  }

  /* Payment summary enhancements */
  .alert-info {
    @apply bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200;
  }

  /* Manual price input styling */
  .manual-price-input {
    @apply border-orange-300 bg-orange-50 dark:bg-orange-900/20 focus:border-orange-500 focus:ring-orange-200;
  }

  .needs-price {
    @apply bg-orange-50 dark:bg-orange-900/10 border-orange-200 dark:border-orange-800;
  }
</style>

{% endblock %}


{% block content %}
<div class="mb-6 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Point of Sale</h1>
  <div class="flex gap-2">
    <a href="{% url 'sales:sale_list' %}" class="btn btn-ghost btn-sm">
      <span class="w-4 h-4 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 15.75L3 12m0 0l3.75-3.75M3 12h18" />
        </svg>
      </span>
      Back to Sales
    </a>
  </div>
</div>

<div x-data="posManager()" x-init="init()">
  <!-- Barcode Scanner Section -->
  <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-base-content flex items-center">
        <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 12h-.01m9.01 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Barcode Scanner
      </h2>
      <div class="flex items-center gap-2">
        <div class="badge badge-success badge-sm scanner-ready" x-show="scannerReady">Ready</div>
        <div class="badge badge-warning badge-sm" x-show="!scannerReady">Initializing...</div>
      </div>
    </div>

    <div class="flex gap-4">
      <div class="flex-1">
        <input type="text" x-model="barcodeInput" x-ref="barcodeField" @keydown.enter="processBarcode()"
          @input="clearMessage()"
          class="input input-lg input-bordered w-full text-center font-mono text-xl bg-white dark:bg-gray-700 focus:ring-4 focus:ring-blue-200 dark:focus:ring-blue-800"
          placeholder="Scan barcode or type manually..." autocomplete="off">
      </div>
      <div class="flex gap-2">
        <input type="number" x-model.number="quickQuantity" min="1" max="999"
          class="input input-lg input-bordered w-20 text-center bg-white dark:bg-gray-700">
        <button type="button" @click="processBarcode()" :disabled="!barcodeInput.trim()" class="btn btn-primary btn-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0 0l4-4m-4 4l-4-4" />
          </svg>
          Add
        </button>
      </div>
    </div>

    <!-- Status Messages -->
    <div x-show="message" class="mt-4" x-transition>
      <div class="alert" :class="messageType === 'success' ? 'alert-success' : 'alert-error'">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span x-text="message"></span>
      </div>
    </div>
  </div>

  <!-- Cart and Checkout Section -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Cart Items -->
    <div class="lg:col-span-2">
      <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-base-content flex items-center">
            <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13v6a1 1 0 001 1h9a1 1 0 001-1v-6M7 13H5.4" />
            </svg>
            Cart Items
            <span class="ml-2 badge badge-primary" x-text="cart.length" x-show="cart.length > 0"></span>
            <span class="ml-2 badge badge-warning" x-text="itemsNeedingPrice + ' need price'" 
                  x-show="itemsNeedingPrice > 0"></span>
          </h2>
          <div class="flex gap-2">
            <button type="button" @click="openManualAdd()" class="btn btn-outline btn-sm">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
              </svg>
              Manual Add
            </button>
            <button type="button" @click="clearCart()" :disabled="cart.length === 0" class="btn btn-error btn-sm">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Clear All
            </button>
          </div>
        </div>

        <!-- Empty Cart State -->
        <div x-show="cart.length === 0" class="text-center py-12 text-base-content/60">
          <div class="flex flex-col items-center gap-3">
            <div class="w-16 h-16 rounded-full bg-base-200 flex items-center justify-center">
              <svg class="w-8 h-8 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13v6a1 1 0 001 1h9a1 1 0 001-1v-6M7 13H5.4" />
              </svg>
            </div>
            <span class="font-medium text-lg">Cart is empty</span>
            <span class="text-sm text-base-content/40">Scan a barcode to start adding items</span>
          </div>
        </div>

        <!-- Cart Items Table -->
        <div x-show="cart.length > 0" class="overflow-x-auto">
          <table class="table w-full text-sm">
            <thead class="bg-base-200/50">
              <tr>
                <th class="font-semibold">Product</th>
                <th class="font-semibold">Barcode</th>
                <th class="font-semibold">Qty</th>
                <th class="font-semibold">Unit Price</th>
                <th class="font-semibold">Total</th>
                <th class="font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(item, index) in cart" :key="item.stock_item_id">
                <tr class="hover:bg-base-200/30 transition-colors" 
                    :class="item.needs_manual_price ? 'needs-price' : ''">
                  <td>
                    <div class="font-medium" x-text="item.product_name"></div>
                    <div class="text-xs text-gray-500" x-text="'Available: ' + item.available_quantity"></div>
                    <div x-show="item.needs_manual_price" class="text-xs text-orange-600 font-medium mt-1">
                      ⚠️ Price required
                    </div>
                  </td>
                  <td>
                    <span class="font-mono text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded"
                      x-text="item.barcode"></span>
                  </td>
                  <td>
                    <div class="flex items-center gap-1">
                      <button type="button" @click="updateQuantity(item.stock_item_id, item.quantity - 1)"
                        :disabled="item.quantity <= 1" class="btn btn-xs btn-circle btn-outline">−</button>
                      <input type="number" :value="item.quantity"
                        @change="updateQuantity(item.stock_item_id, parseInt($event.target.value))" min="1"
                        :max="item.available_quantity" class="input input-xs input-bordered w-16 text-center">
                      <button type="button" @click="updateQuantity(item.stock_item_id, item.quantity + 1)"
                        :disabled="item.quantity >= item.available_quantity"
                        class="btn btn-xs btn-circle btn-outline">+</button>
                    </div>
                  </td>
                  <td>
                    <div x-show="!item.needs_manual_price" class="font-semibold text-info" 
                         x-text="'৳ ' + parseFloat(item.sale_price || 0).toFixed(2)"></div>
                    <div x-show="item.needs_manual_price" class="flex items-center gap-1">
                      <input type="number" 
                             x-model="tempPrices[item.stock_item_id]"
                             @keydown.enter="updateManualPrice(item.stock_item_id)"
                             step="0.01" min="0.01" 
                             placeholder="Enter price"
                             class="input input-xs manual-price-input w-20 text-center">
                      <button type="button" 
                              @click="updateManualPrice(item.stock_item_id)"
                              :disabled="!tempPrices[item.stock_item_id] || tempPrices[item.stock_item_id] <= 0"
                              class="btn btn-xs btn-success">
                        ✓
                      </button>
                    </div>
                  </td>
                  <td>
                    <div x-show="!item.needs_manual_price" class="font-bold text-success"
                         x-text="'৳ ' + (item.quantity * parseFloat(item.sale_price || 0)).toFixed(2)"></div>
                    <div x-show="item.needs_manual_price" class="font-bold text-orange-600">
                      Set price first
                    </div>
                  </td>
                  <td>
                    <button type="button" @click="removeItem(item.stock_item_id)" class="btn btn-error btn-xs">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Checkout Panel -->
    <div class="lg:col-span-1">
      <div class="bg-base-100 rounded-lg shadow-sm border border-base-300 p-6 sticky top-6">
        <h2 class="text-xl font-semibold text-base-content mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
          Checkout
        </h2>

        <!-- Payment Summary -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mb-4 border border-gray-200 dark:border-gray-600">
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Items:</span>
              <span class="font-medium" x-text="cart.length"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Subtotal:</span>
              <span class="font-semibold text-blue-600 dark:text-blue-400" 
                    x-text="subtotal > 0 ? '৳ ' + subtotal.toFixed(2) : '৳ 0.00'"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Discount:</span>
              <span class="font-semibold text-orange-600 dark:text-orange-400"
                x-text="'৳ ' + discountAmount.toFixed(2)"></span>
            </div>
            <hr class="border-gray-300 dark:border-gray-600">
            <div class="flex justify-between text-lg font-bold">
              <span class="text-gray-900 dark:text-gray-100">Total:</span>
              <span class="text-green-600 dark:text-green-400" 
                    x-text="finalTotal > 0 ? '৳ ' + finalTotal.toFixed(2) : '৳ 0.00'"></span>
            </div>

            <!-- Items Needing Price Alert -->
            <div x-show="itemsNeedingPrice > 0" class="mt-2 p-2 bg-orange-100 dark:bg-orange-900/30 rounded border border-orange-200 dark:border-orange-800">
              <div class="text-xs text-orange-700 dark:text-orange-300 font-medium">
                ⚠️ <span x-text="itemsNeedingPrice"></span> item(s) need price entry
              </div>
            </div>

            <!-- Payment Status Display -->
            <div x-show="amountReceived > 0" class="pt-2 border-t border-gray-300 dark:border-gray-600">
              <div class="flex justify-between">
                <span class="text-gray-700 dark:text-gray-300">Amount Received:</span>
                <span class="font-semibold text-blue-600 dark:text-blue-400"
                  x-text="'৳ ' + amountReceived.toFixed(2)"></span>
              </div>

              <!-- Change/Due Amount -->
              <div x-show="changeAmount !== 0" class="flex justify-between text-base font-bold mt-2 p-2 rounded"
                :class="changeAmount >= 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'">
                <span x-text="changeAmount >= 0 ? 'Change Due:' : 'Amount Due:'"></span>
                <span x-text="'৳ ' + Math.abs(changeAmount).toFixed(2)"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Discount Input -->
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text font-medium">Discount (৳)</span>
          </label>
          <input type="number" x-model.number="discountAmount" step="0.01" min="0" :max="subtotal"
            @input="updatePaymentSummary()" class="input input-bordered bg-white dark:bg-gray-700" placeholder="0.00">
        </div>

        <!-- Amount Received Input -->
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text font-medium">Amount Received (৳)</span>
            <span class="label-text-alt text-red-500" x-show="cart.length > 0">*</span>
          </label>
          <input type="number" x-model.number="amountReceived" step="0.01" min="0" @input="updatePaymentSummary()"
            :class="{'input-error border-red-500': amountReceived > 0 && amountReceived < finalTotal}"
            class="input input-bordered bg-white dark:bg-gray-700" placeholder="0.00">
          <label class="label" x-show="amountReceived > 0 && amountReceived < finalTotal">
            <span class="label-text-alt text-red-500">⚠️ Insufficient amount received</span>
          </label>
        </div>

        <!-- Quick Amount Buttons -->
        <div x-show="finalTotal > 0"
          class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-4 border border-blue-200 dark:border-blue-800">
          <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-2 text-sm">Quick Amount Entry</h4>
          <div class="grid grid-cols-3 gap-1 mb-2">
            <template x-for="amount in quickAmounts" :key="amount">
              <button type="button" @click="setQuickAmount(amount)" class="btn btn-xs btn-outline btn-primary text-xs"
                x-text="'৳ ' + amount"></button>
            </template>
          </div>
          <button type="button" @click="setExactAmount()"
            class="btn btn-xs btn-outline btn-secondary w-full text-xs">Exact Amount</button>
        </div>

        <!-- Notes -->
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text font-medium">Notes (Optional)</span>
          </label>
          <textarea x-model="notes" class="textarea textarea-bordered bg-white dark:bg-gray-700"
            placeholder="Sale notes..." rows="2"></textarea>
        </div>

        <!-- Checkout Button -->
        <button type="button" @click="finalizeSale()" :disabled="!canCompleteSale || processing"
          class="btn btn-lg w-full mb-3" :class="canCompleteSale ? 'btn-success' : 'btn-disabled'">
          <svg x-show="!processing" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span x-show="processing" class="loading loading-spinner loading-sm mr-2"></span>
          <span x-text="getCompleteButtonText()"></span>
        </button>

        <!-- Quick Actions -->
        <div class="grid grid-cols-2 gap-2 mb-3">
          <button type="button" @click="focusBarcode()" class="btn btn-outline btn-sm">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M12 12h-.01m9.01 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Focus Scanner
          </button>
          <button type="button" @click="clearCart()" :disabled="cart.length === 0" class="btn btn-outline btn-sm">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4l16 16m0 0V8a2 2 0 00-2-2H8m8 12H6a2 2 0 01-2-2V8" />
            </svg>
            Clear Cart
          </button>
        </div>

        <!-- Hold/Resume Sale -->
        <div class="grid grid-cols-2 gap-2">
          <button type="button" @click="holdSale()" :disabled="cart.length === 0" class="btn btn-warning btn-sm">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Hold Sale
          </button>
          <button type="button" @click="showHeldSales()" class="btn btn-info btn-sm">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
            Held Sales
          </button>
        </div>

        <!-- Keyboard Shortcuts Help -->
        <div class="alert alert-info text-xs mt-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            class="stroke-current shrink-0 w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <div><kbd>F1</kbd> Focus Scanner</div>
            <div><kbd>F2</kbd> Clear Cart</div>
            <div><kbd>F12</kbd> Complete Sale</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_script %}
<script>
  function posManager() {
    return {
      cart: [],
      barcodeInput: '',
      quickQuantity: 1,
      discountAmount: 0,
      amountReceived: 0,
      notes: '',
      message: '',
      messageType: 'success',
      scannerReady: false,
      processing: false,
      tempPrices: {}, // For storing temporary manual prices before confirmation

      init() {
        // Load initial cart from session
        this.loadCart();

        // Auto-focus barcode input
        this.$nextTick(() => {
          this.focusBarcode();
          this.scannerReady = true;
        });

        // Set up keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // F1 - Focus barcode field
          if (e.key === 'F1') {
            e.preventDefault();
            this.focusBarcode();
          }
          // F2 - Clear cart
          if (e.key === 'F2') {
            e.preventDefault();
            this.clearCart();
          }
          // F12 - Complete sale
          if (e.key === 'F12') {
            e.preventDefault();
            if (this.canCompleteSale) {
              this.finalizeSale();
            }
          }
          // ESC - Clear messages
          if (e.key === 'Escape') {
            this.clearMessage();
          }
        });
      },

      get subtotal() {
        return this.cart.reduce((sum, item) => {
          if (item.needs_manual_price || item.sale_price === null) {
            return sum; // Don't include items without prices in subtotal
          }
          return sum + (item.quantity * parseFloat(item.sale_price || 0));
        }, 0);
      },

      get finalTotal() {
        return Math.max(0, this.subtotal - this.discountAmount);
      },

      get changeAmount() {
        return this.amountReceived - this.finalTotal;
      },

      get itemsNeedingPrice() {
        return this.cart.filter(item => item.needs_manual_price).length;
      },

      get canCompleteSale() {
        return this.cart.length > 0 &&
          this.itemsNeedingPrice === 0 && // All items must have prices
          this.amountReceived > 0 &&
          this.amountReceived >= this.finalTotal &&
          this.subtotal > 0; // Must have at least some priced items
      },

      get quickAmounts() {
        const total = this.finalTotal;
        if (total <= 0) return [100, 500, 1000];

        // Generate smart quick amounts based on total
        const amounts = [];
        const roundedTotal = Math.ceil(total);

        // Add exact amount
        amounts.push(roundedTotal);

        // Add common denominations above total
        const denominations = [10, 20, 50, 100, 200, 500, 1000, 2000, 5000];

        denominations.forEach(denom => {
          if (denom > total && amounts.length < 6) {
            amounts.push(denom);
          }
        });

        // Ensure we have at least a few options
        if (amounts.length < 3) {
          amounts.push(roundedTotal + 50, roundedTotal + 100, roundedTotal + 500);
        }

        return [...new Set(amounts)].sort((a, b) => a - b).slice(0, 6);
      },

      getCompleteButtonText() {
        if (this.cart.length === 0) {
          return 'Add Items to Continue';
        }
        if (this.itemsNeedingPrice > 0) {
          return `Set Price for ${this.itemsNeedingPrice} Item(s)`;
        }
        if (this.amountReceived === 0) {
          return 'Enter Amount Received';
        }
        if (this.amountReceived < this.finalTotal) {
          return `Need ৳${(this.finalTotal - this.amountReceived).toFixed(2)} More`;
        }
        if (this.changeAmount > 0) {
          return `Complete Sale (Change: ৳${this.changeAmount.toFixed(2)})`;
        }
        return 'Complete Sale';
      },

      async loadCart() {
        // Load cart from server session
        this.cart = {{ cart | safe }} || [];
        
        // Initialize tempPrices for items needing manual price
        this.cart.forEach(item => {
          if (item.needs_manual_price) {
            this.tempPrices[item.stock_item_id] = '';
          }
        });
      },

      focusBarcode() {
        this.$refs.barcodeField.focus();
        this.$refs.barcodeField.select();
      },

      clearMessage() {
        this.message = '';
      },

      showMessage(msg, type = 'success') {
        this.message = msg;
        this.messageType = type;

        // Auto-hide after 3 seconds
        setTimeout(() => {
          this.message = '';
        }, 3000);
      },

      setQuickAmount(amount) {
        this.amountReceived = amount;
        this.updatePaymentSummary();
      },

      setExactAmount() {
        this.amountReceived = this.finalTotal;
        this.updatePaymentSummary();
      },

      updatePaymentSummary() {
        // Payment summary is automatically updated by computed properties
      },

      async processBarcode() {
        if (!this.barcodeInput.trim()) {
          this.showMessage('Please enter a barcode', 'error');
          return;
        }

        try {
          const formData = new FormData();
          formData.append('action', 'add_item');
          formData.append('barcode', this.barcodeInput.trim());
          formData.append('quantity', this.quickQuantity);
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

          const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const data = await response.json();

          if (data.status === 'success') {
            this.cart = data.cart;
            
            // Initialize temp prices for new items needing manual price
            this.cart.forEach(item => {
              if (item.needs_manual_price && !(item.stock_item_id in this.tempPrices)) {
                this.tempPrices[item.stock_item_id] = '';
              }
            });
            
            this.showMessage(data.message, 'success');

            // Clear input fields after successful addition
            this.barcodeInput = '';
            this.quickQuantity = 1;

            // Refocus barcode input
            this.$nextTick(() => {
              this.focusBarcode();
            });
          } else {
            this.showMessage(data.message, 'error');
          }
        } catch (error) {
          this.showMessage('Error adding item', 'error');
          console.error('Error:', error);
        }
      },

      async updateManualPrice(stockItemId) {
        const price = parseFloat(this.tempPrices[stockItemId]);
        
        if (!price || price <= 0) {
          this.showMessage('Please enter a valid price greater than 0', 'error');
          return;
        }

        try {
          const formData = new FormData();
          formData.append('action', 'update_manual_price');
          formData.append('stock_item_id', stockItemId);
          formData.append('manual_price', price);
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

          const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const data = await response.json();

          if (data.status === 'success') {
            this.cart = data.cart;
            // Clear the temp price for this item
            delete this.tempPrices[stockItemId];
            this.showMessage(data.message, 'success');
          } else {
            this.showMessage(data.message, 'error');
          }
        } catch (error) {
          this.showMessage('Error updating price', 'error');
          console.error('Error:', error);
        }
      },

      async removeItem(stockItemId) {
        try {
          const formData = new FormData();
          formData.append('action', 'remove_item');
          formData.append('stock_item_id', stockItemId);
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

          const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const data = await response.json();

          if (data.status === 'success') {
            this.cart = data.cart;
            // Clean up temp price for removed item
            delete this.tempPrices[stockItemId];
            this.showMessage(data.message, 'success');
          } else {
            this.showMessage(data.message, 'error');
          }
        } catch (error) {
          this.showMessage('Error removing item', 'error');
          console.error('Error:', error);
        }
      },

      async updateQuantity(stockItemId, newQuantity) {
        if (newQuantity < 1) return;

        try {
          const formData = new FormData();
          formData.append('action', 'update_quantity');
          formData.append('stock_item_id', stockItemId);
          formData.append('quantity', newQuantity);
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

          const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const data = await response.json();

          if (data.status === 'success') {
            this.cart = data.cart;
            this.showMessage(data.message, 'success');
          } else {
            this.showMessage(data.message, 'error');
          }
        } catch (error) {
          this.showMessage('Error updating quantity', 'error');
          console.error('Error:', error);
        }
      },

      async clearCart() {
        if (this.cart.length === 0) return;

        if (!confirm('Are you sure you want to clear the entire cart?')) return;

        try {
          const formData = new FormData();
          formData.append('action', 'clear_cart');
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

          const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const data = await response.json();

          if (data.status === 'success') {
            this.cart = [];
            this.tempPrices = {};
            this.discountAmount = 0;
            this.amountReceived = 0;
            this.notes = '';
            this.barcodeInput = '';
            this.quickQuantity = 1;
            this.showMessage('Cart cleared successfully', 'success');

            // Refocus barcode input
            this.$nextTick(() => {
              this.focusBarcode();
            });
          } else {
            this.showMessage(data.message, 'error');
          }
        } catch (error) {
          // Fallback: clear cart locally if server request fails
          this.cart = [];
          this.tempPrices = {};
          this.discountAmount = 0;
          this.amountReceived = 0;
          this.notes = '';
          this.barcodeInput = '';
          this.quickQuantity = 1;
          this.showMessage('Cart cleared locally', 'success');

          // Refocus barcode input
          this.$nextTick(() => {
            this.focusBarcode();
          });

          console.error('Error clearing cart:', error);
        }
      },

      async finalizeSale() {
        if (this.cart.length === 0) {
          this.showMessage('Cart is empty', 'error');
          return;
        }

        if (this.itemsNeedingPrice > 0) {
          this.showMessage('Please set prices for all items before completing sale', 'error');
          return;
        }

        if (this.amountReceived === 0) {
          this.showMessage('Please enter the amount received from customer', 'error');
          return;
        }

        if (this.amountReceived < this.finalTotal) {
          this.showMessage(`Insufficient amount received. Need ৳${(this.finalTotal - this.amountReceived).toFixed(2)} more`, 'error');
          return;
        }

        if (this.discountAmount > this.subtotal) {
          this.showMessage('Discount cannot exceed subtotal', 'error');
          return;
        }

        // Show change confirmation if there's change due
        if (this.changeAmount > 0) {
          const confirmed = confirm(`Change due: ৳${this.changeAmount.toFixed(2)}\n\nDo you want to complete this sale?`);
          if (!confirmed) return;
        }

        this.processing = true;

        try {
          const formData = new FormData();
          formData.append('action', 'finalize_sale');
          formData.append('discount_amount', this.discountAmount);
          formData.append('amount_received', this.amountReceived);
          formData.append('notes', this.notes);
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

          const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const data = await response.json();

          if (data.status === 'success') {
            this.showMessage(data.message, 'success');

            // Reset form
            this.cart = [];
            this.tempPrices = {};
            this.discountAmount = 0;
            this.amountReceived = 0;
            this.notes = '';

            // Redirect after short delay
            setTimeout(() => {
              if (data.redirect_url) {
                window.location.href = data.redirect_url;
              }
            }, 1500);
          } else {
            this.showMessage(data.message, 'error');
          }
        } catch (error) {
          this.showMessage('Error completing sale', 'error');
          console.error('Error:', error);
        } finally {
          this.processing = false;
        }
      },

      openManualAdd() {
        // This would open a modal for manual product search/add
        // Similar to the first page's functionality
        alert('Manual add feature - integrate with product search modal');
      },

      async holdSale() {
        if (this.cart.length === 0) {
          this.showMessage('No items in cart to hold', 'error');
          return;
        }

        const saleId = prompt('Enter sale ID for holding (optional):') || `HOLD_${Date.now()}`;

        try {
          const formData = new FormData();
          formData.append('action', 'hold_sale');
          formData.append('sale_id', saleId);
          formData.append('discount_amount', this.discountAmount);
          formData.append('amount_received', this.amountReceived);
          formData.append('notes', this.notes);
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

          const response = await fetch('', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const data = await response.json();

          if (data.status === 'success') {
            this.showMessage(`Sale held as: ${saleId}`, 'success');

            // Clear current cart
            this.cart = [];
            this.tempPrices = {};
            this.discountAmount = 0;
            this.amountReceived = 0;
            this.notes = '';
            this.focusBarcode();
          } else {
            this.showMessage(data.message, 'error');
          }
        } catch (error) {
          this.showMessage('Error holding sale', 'error');
          console.error('Error:', error);
        }
      },

      showHeldSales() {
        // This would show a modal with held sales list
        alert('Held sales feature - show list of held sales for resumption');
      }
    }
  }
</script>

<!-- Add CSRF token -->
{% csrf_token %}

{% endblock %}